<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familia Finanzas</title>
    <meta name="description" content="Gesti칩n financiera familiar completa">
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游눯</text></svg>">
    
    <style>
        /* Reset y variables CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.5;
            max-width: 100vw;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* Pantalla de carga */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Navegaci칩n */
        #auth-nav, #main-nav {
            background: var(--surface);
            padding: 1rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Contenedor principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Tarjetas */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Botones */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Formularios */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        /* Grid y flex */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        /* Estados */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-success {
            color: var(--secondary);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-warning {
            color: var(--warning);
        }

        .text-muted {
            color: var(--text-light);
        }

        .font-bold {
            font-weight: bold;
        }

        .text-xl {
            font-size: 1.5rem;
        }

        .text-2xl {
            font-size: 2rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        /* Navegaci칩n inferior */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 0.5rem;
            z-index: 90;
        }

        .nav-tabs {
            display: flex;
            justify-content: space-around;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: none;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            border-radius: var(--radius-sm);
        }

        .nav-tab:hover {
            background: var(--background);
        }

        .nav-tab.active {
            color: var(--primary);
            background: var(--background);
        }

        .nav-tab i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .nav-tab span {
            display: block;
            font-size: 0.75rem;
        }

        /* Listas */
        .list {
            list-style: none;
        }

        .list-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        /* Progress bars */
        .progress {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        /* Alertas */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 1rem;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 0.5rem;
            }
            
            .card {
                padding: 1rem;
            }
        }

        /* Iconos */
        @font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: url(https://fonts.gstatic.com/s/materialicons/v140/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }

        /* Tabs de contenido */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Estilos espec칤ficos para gr치ficos */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        /* Estados de saldo */
        .balance-positive {
            color: var(--secondary);
        }

        .balance-negative {
            color: var(--danger);
        }

        /* Tarjetas de resumen */
        .summary-card {
            text-align: center;
            padding: 1.5rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .summary-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Animaciones */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- Pantalla de carga -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Cargando aplicaci칩n...</p>
    </div>

    <!-- Navegaci칩n de autenticaci칩n -->
    <nav id="auth-nav" class="hidden">
        <div class="nav-container">
            <div class="logo">游눯 Familia Finanzas</div>
            <div id="user-menu"></div>
        </div>
    </nav>

    <!-- Navegaci칩n principal -->
    <nav id="main-nav" class="hidden">
        <div class="nav-container">
            <div class="logo">游눯 Familia Finanzas</div>
            <div class="flex items-center gap-2">
                <span id="current-month" class="text-muted"></span>
                <button id="add-movement-btn" class="btn btn-primary btn-sm">
                    <span class="material-icons">add</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenido de autenticaci칩n -->
    <div id="auth-content" class="hidden">
        <div class="container">
            <div class="card" style="max-width: 400px; margin: 2rem auto;">
                <div class="card-header">
                    <h2 class="card-title">Bienvenido</h2>
                </div>
                <div id="auth-tabs">
                    <div class="flex mb-4">
                        <button class="btn btn-outline flex-1" data-tab="login">Iniciar Sesi칩n</button>
                        <button class="btn btn-outline flex-1" data-tab="register">Registrarse</button>
                    </div>
                    
                    <div id="login-tab" class="tab-content active">
                        <form id="login-form">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="login-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase침a</label>
                                <input type="password" class="form-control" id="login-password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Iniciar Sesi칩n</button>
                        </form>
                    </div>
                    
                    <div id="register-tab" class="tab-content">
                        <form id="register-form">
                            <div class="form-group">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" class="form-control" id="register-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="register-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase침a</label>
                                <input type="password" class="form-control" id="register-password" minlength="6" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Crear Cuenta</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div id="main-content" class="hidden">
        <div class="container">
            <!-- Resumen Mensual -->
            <div id="summary-tab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Resumen Mensual</h2>
                        <select id="month-selector" class="form-select" style="width: auto;">
                            <!-- Meses se cargan din치micamente -->
                        </select>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="summary-card">
                            <div class="summary-label">Ingresos Totales</div>
                            <div id="total-income" class="summary-value text-success">$0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Gastos Totales</div>
                            <div id="total-expenses" class="summary-value text-danger">$0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Balance</div>
                            <div id="month-balance" class="summary-value">$0</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="mb-2">Estado Actual</h3>
                        <div class="grid grid-2">
                            <div class="card">
                                <h4 class="mb-2">Saldo Disponible</h4>
                                <div id="available-balance" class="text-2xl font-bold">$0</div>
                                <div class="text-muted mt-1" id="balance-breakdown"></div>
                            </div>
                            <div class="card">
                                <h4 class="mb-2">Ahorro General</h4>
                                <div id="savings-amount" class="text-2xl font-bold">$0</div>
                                <div class="progress">
                                    <div id="savings-progress" class="progress-bar" style="width: 0%"></div>
                                </div>
                                <div class="text-muted mt-1" id="savings-target"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="mb-4">Movimientos Recientes</h3>
                    <div id="recent-movements" class="list">
                        <!-- Movimientos se cargan din치micamente -->
                    </div>
                </div>
            </div>

            <!-- Saldo Disponible -->
            <div id="balance-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title mb-4">Saldo Disponible</h2>
                    
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-icons">money</span>
                                <h3>Efectivo</h3>
                            </div>
                            <div id="cash-balance" class="text-2xl font-bold balance-positive">$0</div>
                            <div class="text-muted">Disponible para gastos</div>
                        </div>
                        
                        <div class="card">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-icons">credit_card</span>
                                <h3>Mercado Pago</h3>
                            </div>
                            <div id="mp-balance" class="text-2xl font-bold balance-positive">$0</div>
                            <div class="text-muted">Saldo digital</div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <h3 class="mb-2">Total Disponible</h3>
                        <div id="total-available" class="text-2xl font-bold">$0</div>
                        <div class="text-muted">Excluye ahorros y fondos</div>
                    </div>
                </div>
            </div>

            <!-- Gastos por Categor칤a -->
            <div id="expenses-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Gastos por Categor칤a</h2>
                        <select id="expense-month-selector" class="form-select" style="width: auto;">
                            <!-- Meses se cargan din치micamente -->
                        </select>
                    </div>
                    
                    <div id="expenses-chart" class="chart-container">
                        <!-- Gr치fico se renderiza din치micamente -->
                    </div>
                    
                    <div id="expenses-ranking" class="list">
                        <!-- Ranking se carga din치micamente -->
                    </div>
                </div>
            </div>

            <!-- Postres -->
            <div id="desserts-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title mb-4">Emprendimiento Postres</h2>
                    
                    <div class="grid grid-3">
                        <div class="summary-card">
                            <div class="summary-label">Ventas Totales</div>
                            <div id="dessert-sales" class="summary-value text-success">$0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Insumos Totales</div>
                            <div id="dessert-costs" class="summary-value text-danger">$0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Ganancia</div>
                            <div id="dessert-profit" class="summary-value">$0</div>
                            <div id="dessert-profitability" class="text-muted"></div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="mb-2">Estado de Rentabilidad</h3>
                        <div id="profitability-status" class="alert alert-success">
                            <span class="material-icons">check_circle</span>
                            El negocio es rentable
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fondos -->
            <div id="funds-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title mb-4">Fondos</h2>
                    
                    <div class="grid grid-2">
                        <div class="card">
                            <h3 class="mb-2">Fondo Hogar</h3>
                            <div id="home-fund-amount" class="text-2xl font-bold">$0</div>
                            <div class="progress">
                                <div id="home-fund-progress" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="text-muted mt-1" id="home-fund-target"></div>
                            <button onclick="editFund('hogar')" class="btn btn-outline btn-sm mt-2">Editar Objetivo</button>
                        </div>
                        
                        <div class="card">
                            <h3 class="mb-2">Fondo Postres</h3>
                            <div id="dessert-fund-amount" class="text-2xl font-bold">$0</div>
                            <div class="progress">
                                <div id="dessert-fund-progress" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="text-muted mt-1" id="dessert-fund-target"></div>
                            <button onclick="editFund('postres')" class="btn btn-outline btn-sm mt-2">Editar Objetivo</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ahorros -->
            <div id="savings-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title mb-4">Ahorro General</h2>
                    
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div id="savings-current" class="text-2xl font-bold">$0</div>
                                <div class="text-muted">Actual</div>
                            </div>
                            <div class="text-right">
                                <div id="savings-target-display" class="text-2xl font-bold">$0</div>
                                <div class="text-muted">Objetivo</div>
                            </div>
                        </div>
                        
                        <div class="progress">
                            <div id="savings-overall-progress" class="progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <div class="mt-4">
                            <button onclick="editSavings()" class="btn btn-primary">Editar Objetivo de Ahorro</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial -->
            <div id="history-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Historial Completo</h2>
                        <div class="flex gap-2">
                            <select id="history-type-filter" class="form-select" style="width: auto;">
                                <option value="all">Todos los tipos</option>
                                <option value="gasto_hogar">Gastos Hogar</option>
                                <option value="ingreso_diario">Ingresos</option>
                                <option value="insumos_postres">Insumos</option>
                                <option value="ventas_postres">Ventas</option>
                                <option value="fondo">Fondos</option>
                                <option value="ahorro">Ahorros</option>
                            </select>
                            <input type="date" id="history-date-filter" class="form-control" style="width: auto;">
                        </div>
                    </div>
                    
                    <div id="history-list" class="list">
                        <!-- Historial se carga din치micamente -->
                    </div>
                    
                    <div id="history-pagination" class="flex justify-center gap-2 mt-4">
                        <!-- Paginaci칩n din치mica -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegaci칩n inferior -->
    <div class="bottom-nav hidden" id="bottom-nav">
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="summary">
                <span class="material-icons">dashboard</span>
                <span>Resumen</span>
            </button>
            <button class="nav-tab" data-tab="balance">
                <span class="material-icons">account_balance_wallet</span>
                <span>Saldo</span>
            </button>
            <button class="nav-tab" data-tab="expenses">
                <span class="material-icons">pie_chart</span>
                <span>Gastos</span>
            </button>
            <button class="nav-tab" data-tab="desserts">
                <span class="material-icons">cake</span>
                <span>Postres</span>
            </button>
            <button class="nav-tab" data-tab="funds">
                <span class="material-icons">savings</span>
                <span>Fondos</span>
            </button>
            <button class="nav-tab" data-tab="savings">
                <span class="material-icons">star</span>
                <span>Ahorro</span>
            </button>
            <button class="nav-tab" data-tab="history">
                <span class="material-icons">history</span>
                <span>Historial</span>
            </button>
        </div>
    </div>

    <!-- Modal para nuevo movimiento -->
    <div id="movement-modal" class="modal hidden">
        <div class="modal-content">
            <div class="card-header">
                <h2 class="card-title">Nuevo Movimiento</h2>
                <button onclick="closeModal()" class="btn btn-outline btn-sm">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <form id="movement-form">
                <div class="p-4">
                    <div class="form-group">
                        <label class="form-label">Tipo de Movimiento</label>
                        <select id="movement-type" class="form-select" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="gasto_hogar">Gasto del Hogar</option>
                            <option value="ingreso_diario">Ingreso Diario</option>
                            <option value="insumos_postres">Insumos Postres</option>
                            <option value="ventas_postres">Ventas Postres</option>
                            <option value="fondo">Fondo</option>
                            <option value="ahorro">Ahorro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Categor칤a</label>
                        <select id="movement-category" class="form-select" required>
                            <!-- Categor칤as se cargan din치micamente seg칰n el tipo -->
                        </select>
                    </div>
                    
                    <div id="person-field" class="form-group hidden">
                        <label class="form-label">Persona</label>
                        <select id="movement-person" class="form-select">
                            <option value="Sebasti치n">Sebasti치n</option>
                            <option value="Ludmila">Ludmila</option>
                        </select>
                    </div>
                    
                    <div id="fund-type-field" class="form-group hidden">
                        <label class="form-label">Tipo de Fondo</label>
                        <select id="movement-fund-type" class="form-select">
                            <option value="hogar">Fondo Hogar</option>
                            <option value="postres">Fondo Postres</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Monto ($)</label>
                        <input type="number" id="movement-amount" class="form-control" min="1" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Medio de Pago</label>
                        <select id="movement-payment" class="form-select" required>
                            <option value="efectivo">Efectivo</option>
                            <option value="mercado_pago">Mercado Pago</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descripci칩n (opcional)</label>
                        <input type="text" id="movement-description" class="form-control" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="movement-date" class="form-control" required>
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button type="button" onclick="closeModal()" class="btn btn-outline flex-1">Cancelar</button>
                        <button type="submit" class="btn btn-primary flex-1">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar objetivos -->
    <div id="goal-modal" class="modal hidden">
        <div class="modal-content">
            <div class="card-header">
                <h2 id="goal-title" class="card-title"></h2>
                <button onclick="closeGoalModal()" class="btn btn-outline btn-sm">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <form id="goal-form">
                <div class="p-4">
                    <div class="form-group">
                        <label class="form-label">Objetivo ($)</label>
                        <input type="number" id="goal-target" class="form-control" min="1" step="0.01" required>
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button type="button" onclick="closeGoalModal()" class="btn btn-outline flex-1">Cancelar</button>
                        <button type="submit" class="btn btn-primary flex-1">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmaci칩n -->
    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content">
            <div class="p-4">
                <h3 id="confirm-title" class="card-title mb-4"></h3>
                <p id="confirm-message"></p>
                <div class="flex gap-2 mt-4">
                    <button onclick="closeConfirmModal(false)" class="btn btn-outline flex-1">Cancelar</button>
                    <button onclick="closeConfirmModal(true)" id="confirm-action" class="btn btn-danger flex-1">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas flotantes -->
    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px;"></div>

    <script>
        // =============================================
        // CONFIGURACI칍N SUPABASE
        // =============================================
        const SUPABASE_URL = 'https://your-project.supabase.co'; // REEMPLAZAR
        const SUPABASE_ANON_KEY = 'your-anon-key'; // REEMPLAZAR
        
        let supabase;
        let currentUser = null;
        let currentMonth = new Date().toISOString().slice(0, 7);
        
        // =============================================
        // CATEGOR칈AS DEFINITIVAS
        // =============================================
        const CATEGORIES = {
            gasto_hogar: [
                'Alquiler', 'Servicios', 'Comida hogar', 'Transporte',
                'Beb칠', 'Mascotas', 'Salud', 'Ropa', 'Imprevistos'
            ],
            ingreso_diario: ['Ingreso diario Sebasti치n', 'Ingreso diario Ludmila'],
            insumos_postres: ['Insumos postres'],
            ventas_postres: ['Ventas postres'],
            fondo: ['Fondo fijo hogar', 'Fondo fijo postres'],
            ahorro: ['Ahorro general']
        };

        // =============================================
        // INICIALIZACI칍N
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            setupEventListeners();
            updateCurrentMonth();
        });

        async function initializeApp() {
            // Cargar Supabase desde CDN
            await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Verificar sesi칩n existente
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserData();
                showMainApp();
            } else {
                showAuthScreen();
            }
            
            hideLoading();
        }

        // =============================================
        // FUNCIONES DE AUTENTICACI칍N
        // =============================================
        async function handleLogin(email, password) {
            try {
                showLoading();
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                await loadUserData();
                showMainApp();
                showAlert('춰Bienvenido de nuevo!', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function handleRegister(name, email, password) {
            try {
                showLoading();
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { full_name: name }
                    }
                });

                if (error) throw error;

                showAlert('춰Cuenta creada! Revisa tu email para confirmar.', 'success');
                showAuthTab('login');
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function handleLogout() {
            try {
                showLoading();
                await supabase.auth.signOut();
                currentUser = null;
                showAuthScreen();
                showAlert('Sesi칩n cerrada correctamente', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // =============================================
        // FUNCIONES DE DATOS
        // =============================================
        async function loadUserData() {
            if (!currentUser) return;

            try {
                // Cargar balances
                await loadBalances();
                
                // Cargar fondos
                await loadFunds();
                
                // Cargar ahorros
                await loadSavings();
                
                // Cargar movimientos del mes actual
                await loadMonthlyMovements();
                
                // Actualizar UI
                updateSummary();
                updateExpensesChart();
                updateDessertsSummary();
            } catch (error) {
                console.error('Error loading user data:', error);
                showAlert('Error al cargar datos', 'error');
            }
        }

        async function loadBalances() {
            const { data, error } = await supabase
                .from('balances')
                .select('*')
                .eq('user_id', currentUser.id);

            if (error) throw error;

            // Si no hay balances, crear iniciales
            if (!data || data.length === 0) {
                await initializeUserBalances();
                return await loadBalances();
            }

            return data;
        }

        async function initializeUserBalances() {
            const { error } = await supabase
                .from('balances')
                .insert([
                    { user_id: currentUser.id, payment_method: 'efectivo', balance: 0 },
                    { user_id: currentUser.id, payment_method: 'mercado_pago', balance: 0 }
                ]);

            if (error) throw error;
        }

        async function loadFunds() {
            const { data, error } = await supabase
                .from('funds')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            if (error) throw error;

            return data;
        }

        async function loadSavings() {
            const { data, error } = await supabase
                .from('savings')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            if (error) throw error;

            return data;
        }

        async function loadMonthlyMovements(month = currentMonth) {
            const startDate = `${month}-01`;
            const endDate = `${month}-31`;

            const { data, error } = await supabase
                .from('movements')
                .select('*')
                .eq('user_id', currentUser.id)
                .gte('movement_date', startDate)
                .lte('movement_date', endDate)
                .order('movement_date', { ascending: false });

            if (error) throw error;

            return data || [];
        }

        // =============================================
        // FUNCIONES DE MOVIMIENTOS
        // =============================================
        async function createMovement(movementData) {
            try {
                showLoading();
                
                const { error } = await supabase
                    .from('movements')
                    .insert([{
                        ...movementData,
                        user_id: currentUser.id,
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                // Recargar datos
                await loadUserData();
                
                closeModal();
                showAlert('Movimiento registrado correctamente', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteMovement(movementId) {
            try {
                showLoading();
                
                const { error } = await supabase
                    .from('movements')
                    .delete()
                    .eq('id', movementId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                // Recargar datos
                await loadUserData();
                
                showAlert('Movimiento eliminado correctamente', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // =============================================
        // FUNCIONES DE C츼LCULO
        // =============================================
        function calculateMonthlySummary(movements) {
            const summary = {
                income: 0,
                expenses: 0,
                sales: 0,
                costs: 0,
                funds: 0,
                savings: 0
            };

            movements.forEach(movement => {
                const amount = parseFloat(movement.amount);
                
                switch (movement.type) {
                    case 'ingreso_diario':
                    case 'ventas_postres':
                        summary.income += amount;
                        if (movement.type === 'ventas_postres') summary.sales += amount;
                        break;
                    case 'gasto_hogar':
                    case 'insumos_postres':
                        summary.expenses += amount;
                        if (movement.type === 'insumos_postres') summary.costs += amount;
                        break;
                    case 'fondo':
                        summary.funds += amount;
                        break;
                    case 'ahorro':
                        summary.savings += amount;
                        break;
                }
            });

            return summary;
        }

        function calculateAvailableBalance(balances, savings) {
            const cash = balances.find(b => b.payment_method === 'efectivo')?.balance || 0;
            const mp = balances.find(b => b.payment_method === 'mercado_pago')?.balance || 0;
            const totalSavings = savings.reduce((sum, s) => sum + parseFloat(s.current_amount), 0);
            
            return {
                cash: cash,
                mp: mp,
                total: cash + mp,
                withoutSavings: cash + mp - totalSavings
            };
        }

        // =============================================
        // FUNCIONES DE UI
        // =============================================
        function showMainApp() {
            document.getElementById('auth-nav').classList.add('hidden');
            document.getElementById('auth-content').classList.add('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden');
        }

        function showAuthScreen() {
            document.getElementById('auth-nav').classList.remove('hidden');
            document.getElementById('auth-content').classList.remove('hidden');
            document.getElementById('main-nav').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('bottom-nav').classList.add('hidden');
            showAuthTab('login');
        }

        function showAuthTab(tabName) {
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) btn.classList.add('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}-tab`) content.classList.add('active');
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) btn.classList.add('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}-tab`) content.classList.add('active');
            });
            
            // Recargar datos espec칤ficos de la pesta침a
            switch (tabName) {
                case 'expenses':
                    updateExpensesChart();
                    break;
                case 'desserts':
                    updateDessertsSummary();
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        }

        function updateSummary() {
            // Esta funci칩n se implementar칤a para actualizar los n칰meros en el resumen
            // usando los datos cargados de movimientos, balances, etc.
        }

        function updateExpensesChart() {
            // Implementar gr치fico de gastos por categor칤a
        }

        function updateDessertsSummary() {
            // Implementar c치lculo de ganancias de postres
        }

        function showModal() {
            document.getElementById('movement-modal').classList.remove('hidden');
            document.getElementById('movement-date').value = new Date().toISOString().split('T')[0];
        }

        function closeModal() {
            document.getElementById('movement-modal').classList.add('hidden');
            document.getElementById('movement-form').reset();
        }

        function showGoalModal(type, title) {
            document.getElementById('goal-title').textContent = title;
            document.getElementById('goal-type').value = type;
            document.getElementById('goal-modal').classList.remove('hidden');
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').classList.add('hidden');
            document.getElementById('goal-form').reset();
        }

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-action').onclick = () => {
                closeConfirmModal(true);
                if (callback) callback();
            };
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal(confirmed) {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirmed && typeof window.confirmCallback === 'function') {
                window.confirmCallback();
            }
        }

        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-icons">
                        ${type === 'success' ? 'check_circle' : 'error'}
                    </span>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('alert-container').appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function updateCurrentMonth() {
            const now = new Date();
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            document.getElementById('current-month').textContent = 
                `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        function setupEventListeners() {
            // Autenticaci칩n
            document.getElementById('login-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await handleLogin(email, password);
            });

            document.getElementById('register-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                await handleRegister(name, email, password);
            });

            // Tabs de autenticaci칩n
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.addEventListener('click', () => {
                    showAuthTab(btn.dataset.tab);
                });
            });

            // Navegaci칩n inferior
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    showTab(btn.dataset.tab);
                });
            });

            // Bot칩n para nuevo movimiento
            document.getElementById('add-movement-btn')?.addEventListener('click', showModal);

            // Formulario de movimiento
            document.getElementById('movement-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const type = document.getElementById('movement-type').value;
                const category = document.getElementById('movement-category').value;
                const amount = parseFloat(document.getElementById('movement-amount').value);
                const payment = document.getElementById('movement-payment').value;
                const description = document.getElementById('movement-description').value;
                const date = document.getElementById('movement-date').value;
                
                let movementData = {
                    type,
                    category,
                    amount,
                    payment_method: payment,
                    description,
                    movement_date: date
                };
                
                // Campos adicionales seg칰n tipo
                if (type === 'ingreso_diario') {
                    movementData.person = document.getElementById('movement-person').value;
                } else if (type === 'fondo') {
                    movementData.fund_type = document.getElementById('movement-fund-type').value;
                }
                
                await createMovement(movementData);
            });

            // Cambiar categor칤as seg칰n tipo
            document.getElementById('movement-type')?.addEventListener('change', function() {
                const type = this.value;
                const categorySelect = document.getElementById('movement-category');
                const personField = document.getElementById('person-field');
                const fundField = document.getElementById('fund-type-field');
                
                // Mostrar/ocultar campos adicionales
                personField.classList.toggle('hidden', type !== 'ingreso_diario');
                fundField.classList.toggle('hidden', type !== 'fondo');
                
                // Actualizar categor칤as
                categorySelect.innerHTML = '';
                if (type && CATEGORIES[type]) {
                    CATEGORIES[type].forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categorySelect.appendChild(option);
                    });
                }
            });
        }

        // =============================================
        // PWA FUNCTIONS
        // =============================================
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('Service Worker registrado'))
                    .catch(err => console.error('Error SW:', err));
            }
        }

        function showInstallPrompt() {
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Mostrar bot칩n de instalaci칩n
                const installBtn = document.createElement('button');
                installBtn.className = 'btn btn-primary';
                installBtn.innerHTML = '<span class="material-icons">download</span> Instalar App';
                installBtn.onclick = () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usuario acept칩 instalaci칩n');
                        }
                        deferredPrompt = null;
                    });
                };
                
                document.getElementById('user-menu')?.appendChild(installBtn);
            });
        }

        // =============================================
        // FUNCIONES AUXILIARES
        // =============================================
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-AR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        // Inicializar PWA
        registerServiceWorker();
        showInstallPrompt();
    </script>
</body>
</html>
