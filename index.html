<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Familiares</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <meta name="theme-color" content="#4f46e5">
    <style>
        /* ===== RESET Y BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 5rem;
        }
        
        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3 {
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }
        
        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1rem; }
        
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        
        /* ===== LAYOUT ===== */
        .container {
            max-width: 100%;
            padding: var(--spacing-md);
        }
        
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .grid {
            display: grid;
            gap: var(--spacing-md);
        }
        
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        
        .flex {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: var(--spacing-xs); }
        .gap-2 { gap: var(--spacing-sm); }
        .gap-3 { gap: var(--spacing-md); }
        .gap-4 { gap: var(--spacing-lg); }
        
        /* ===== COMPONENTS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            gap: var(--spacing-sm);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
        }
        
        .btn-icon {
            padding: 0.5rem;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
        }
        
        .btn-full {
            width: 100%;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            background: var(--background);
            border: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .select {
            appearance: none;
            background: white url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E") right 0.75rem center/1.5em no-repeat;
            padding-right: 2.5rem;
        }
        
        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-light);
        }
        
        /* ===== NAVIGATION ===== */
        .navbar {
            position: sticky;
            top: 0;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: var(--spacing-md);
            z-index: 100;
        }
        
        .nav-tabs {
            display: flex;
            overflow-x: auto;
            padding-bottom: 2px;
            gap: 0;
        }
        
        .nav-tab {
            padding: var(--spacing-sm) var(--spacing-md);
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* ===== SECTIONS ===== */
        .section {
            margin-bottom: var(--spacing-xl);
        }
        
        .section-header {
            margin-bottom: var(--spacing-lg);
        }
        
        /* ===== CHARTS ===== */
        .progress-bar {
            height: 0.75rem;
            background: var(--border);
            border-radius: 9999px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }
        
        .progress-success { background: var(--secondary); }
        .progress-warning { background: var(--warning); }
        .progress-danger { background: var(--danger); }
        
        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-success { color: var(--secondary); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .p-2 { padding: var(--spacing-sm); }
        .p-3 { padding: var(--spacing-md); }
        .p-4 { padding: var(--spacing-lg); }
        
        /* ===== MODAL ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--spacing-md);
        }
        
        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
        }
        
        .modal-body {
            padding: var(--spacing-lg);
        }
        
        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--spacing-sm);
        }
        
        /* ===== SPECIFIC COMPONENTS ===== */
        .balance-card {
            text-align: center;
        }
        
        .balance-amount {
            font-size: 2rem;
            font-weight: 700;
            margin: var(--spacing-sm) 0;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border);
        }
        
        .category-item:last-child {
            border-bottom: none;
        }
        
        .transaction-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border);
        }
        
        .transaction-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-sm);
            background: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .transaction-details {
            flex: 1;
            min-width: 0;
        }
        
        .transaction-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .transaction-meta {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .transaction-amount {
            font-weight: 600;
            white-space: nowrap;
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        /* ===== LOADING ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        .spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin: 0 auto;
            }
            
            h1 { font-size: 2rem; }
            
            .balance-amount { font-size: 2.5rem; }
        }
        
        /* ===== DARK MODE SUPPORT ===== */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0f172a;
                --surface: #1e293b;
                --text: #f1f5f9;
                --text-light: #94a3b8;
                --border: #334155;
                --shadow: 0 1px 3px rgba(0,0,0,0.3);
            }
            
            .input, .select {
                background-color: #334155;
                border-color: #475569;
                color: var(--text);
            }
            
            .chip {
                background: #334155;
            }
            
            .badge-success { background: #065f46; color: #d1fae5; }
            .badge-warning { background: #92400e; color: #fef3c7; }
            .badge-danger { background: #991b1b; color: #fee2e2; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="flex justify-between items-center">
            <h1>üí∞ Finanzas Familiares</h1>
            <div class="flex gap-2">
                <button id="authBtn" class="btn btn-outline btn-icon">
                    üë§
                </button>
                <button id="installBtn" class="btn btn-primary btn-icon">
                    üì±
                </button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="nav-tabs mt-3">
            <a href="#" class="nav-tab active" data-tab="dashboard">üè† Resumen</a>
            <a href="#" class="nav-tab" data-tab="balances">üí∞ Saldos</a>
            <a href="#" class="nav-tab" data-tab="expenses">üìä Gastos</a>
            <a href="#" class="nav-tab" data-tab="business">üéÇ Postres</a>
            <a href="#" class="nav-tab" data-tab="funds">üéØ Fondos</a>
            <a href="#" class="nav-tab" data-tab="history">üìú Historial</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Dashboard Tab -->
        <section id="dashboard" class="tab-content">
            <div class="section">
                <div class="card">
                    <h2>Resumen Mensual</h2>
                    <div class="grid grid-2 gap-3 mt-3">
                        <div class="stat-card">
                            <div class="stat-value text-success" id="total-income">$0</div>
                            <div class="stat-label">Ingresos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-danger" id="total-expense">$0</div>
                            <div class="stat-label">Gastos Hogar</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="business-net">$0</div>
                            <div class="stat-label">Resultado Postres</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="final-balance">$0</div>
                            <div class="stat-label">Balance Final</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="flex justify-between mb-2">
                            <span>Estado General</span>
                            <span id="status-indicator" class="badge badge-success">OK</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-success" id="status-progress" style="width: 75%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Acciones R√°pidas</h2>
                <div class="grid grid-3 gap-2">
                    <button class="btn btn-outline btn-icon" data-action="add-expense">
                        <span>üí∏</span>
                    </button>
                    <button class="btn btn-outline btn-icon" data-action="add-income">
                        <span>üí∞</span>
                    </button>
                    <button class="btn btn-outline btn-icon" data-action="add-sale">
                        <span>üéÇ</span>
                    </button>
                </div>
                <div class="grid grid-3 gap-2 mt-2 text-center text-xs">
                    <span>Gasto</span>
                    <span>Ingreso</span>
                    <span>Venta</span>
                </div>
            </div>
            
            <div class="section">
                <h2>√öltimos Movimientos</h2>
                <div class="card">
                    <div id="recent-transactions"></div>
                </div>
            </div>
        </section>

        <!-- Balances Tab -->
        <section id="balances" class="tab-content hidden">
            <div class="section">
                <h2>Saldos Disponibles</h2>
                <div class="grid grid-2 gap-3">
                    <div class="card balance-card">
                        <div class="text-2xl">üíµ</div>
                        <h3>Efectivo</h3>
                        <div class="balance-amount" id="cash-balance">$0</div>
                    </div>
                    <div class="card balance-card">
                        <div class="text-2xl">üì±</div>
                        <h3>Mercado Pago</h3>
                        <div class="balance-amount" id="mp-balance">$0</div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="flex justify-between items-center">
                        <h3>Total Combinado</h3>
                        <div class="text-2xl font-bold" id="total-balance">$0</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Expenses Tab -->
        <section id="expenses" class="tab-content hidden">
            <div class="section">
                <h2>Gastos por Categor√≠a</h2>
                <div class="card">
                    <div id="category-chart"></div>
                </div>
            </div>
            
            <div class="section">
                <h2>Comparaci√≥n Mensual</h2>
                <div class="card">
                    <div id="month-comparison"></div>
                </div>
            </div>
        </section>

        <!-- Business Tab -->
        <section id="business" class="tab-content hidden">
            <div class="section">
                <h2>Emprendimiento Postres</h2>
                <div class="grid grid-3 gap-3 mb-4">
                    <div class="card stat-card">
                        <div class="stat-value text-success" id="total-sales">$0</div>
                        <div class="stat-label">Ventas</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-value text-danger" id="total-supplies">$0</div>
                        <div class="stat-label">Insumos</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-value" id="business-profit">$0</div>
                        <div class="stat-label">Ganancia</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Fondo Postres</h3>
                    <div class="flex justify-between mb-2">
                        <span>Progreso</span>
                        <span id="business-fund-progress">$0 / $50,000</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-warning" id="business-fund-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Funds Tab -->
        <section id="funds" class="tab-content hidden">
            <div class="section">
                <h2>Fondos de Ahorro</h2>
                <div class="card">
                    <h3>Fondo Hogar</h3>
                    <div class="flex justify-between mb-2">
                        <span>Objetivo: $100,000</span>
                        <span id="home-fund-progress">$0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-success" id="home-fund-bar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-sm" id="home-fund-remaining"></div>
                </div>
                
                <div class="card mt-3">
                    <h3>Fondo Postres</h3>
                    <div class="flex justify-between mb-2">
                        <span>Objetivo: $50,000</span>
                        <span id="dessert-fund-progress">$0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-warning" id="dessert-fund-bar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-sm" id="dessert-fund-remaining"></div>
                </div>
                
                <button class="btn btn-primary btn-full mt-3" data-action="transfer-funds">
                    Transferir entre Fondos
                </button>
            </div>
        </section>

        <!-- History Tab -->
        <section id="history" class="tab-content hidden">
            <div class="section">
                <div class="card">
                    <div class="flex justify-between items-center mb-3">
                        <h2>Historial</h2>
                        <div class="flex gap-2">
                            <select id="filter-person" class="select text-sm">
                                <option value="">Todas las personas</option>
                            </select>
                            <select id="filter-category" class="select text-sm">
                                <option value="">Todas las categor√≠as</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="history-list"></div>
                    
                    <div class="mt-3">
                        <button id="load-more" class="btn btn-outline btn-full">
                            Cargar m√°s movimientos
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal para agregar movimiento -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Nuevo Movimiento</h2>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    <div class="mb-3">
                        <label class="label">Tipo</label>
                        <select id="transaction-type" class="input select" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="expense">Gasto Hogar</option>
                            <option value="income">Ingreso Diario</option>
                            <option value="business_expense">Insumos Postres</option>
                            <option value="business_income">Venta Postres</option>
                            <option value="fund_transfer">Transferencia Fondos</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="label">Fecha</label>
                        <input type="date" id="transaction-date" class="input" required value="">
                    </div>
                    
                    <div class="mb-3">
                        <label class="label">Monto ($)</label>
                        <input type="number" id="transaction-amount" class="input" min="0.01" step="0.01" required placeholder="0.00">
                    </div>
                    
                    <!-- Campos din√°micos seg√∫n tipo -->
                    <div id="dynamic-fields"></div>
                    
                    <div class="mb-3">
                        <label class="label">Nota (opcional)</label>
                        <input type="text" id="transaction-note" class="input" placeholder="Descripci√≥n breve">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="modal-cancel">Cancelar</button>
                <button type="submit" form="transaction-form" class="btn btn-primary" id="modal-save">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Iniciar Sesi√≥n</h2>
            </div>
            <div class="modal-body">
                <div id="auth-state">
                    <div class="mb-3">
                        <label class="label">Email</label>
                        <input type="email" id="auth-email" class="input" placeholder="tu@email.com">
                    </div>
                    <div class="mb-3">
                        <label class="label">Contrase√±a</label>
                        <input type="password" id="auth-password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button id="auth-login" class="btn btn-primary btn-full mb-2">Ingresar</button>
                    <button id="auth-signup" class="btn btn-outline btn-full">Crear Cuenta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Install Prompt -->
    <div id="install-prompt" class="modal hidden">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center p-4">
                    <div class="text-4xl mb-3">üì±</div>
                    <h2 class="mb-2">Instalar App</h2>
                    <p class="mb-4">Instala esta aplicaci√≥n en tu celular para usarla m√°s r√°pido y sin conexi√≥n.</p>
                    <button id="install-confirm" class="btn btn-primary btn-full mb-2">Instalar</button>
                    <button id="install-cancel" class="btn btn-outline btn-full">Ahora no</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="modal">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://rdscdgohbrkqnuxjyalg.supabase.co'; // Reemplazar
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc2NkZ29oYnJrcW51eGp5YWxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4OTk0NDUsImV4cCI6MjA4NTQ3NTQ0NX0.nrjtRfGMBdq0KKxZaxG8Z6-CQArxdVB9hHkY-50AXMI'; // Reemplazar
        
        // Inicializar Supabase
        const supabaseClient = window.supabase ? 
            window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : 
            null;

        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let state = {
            user: null,
            session: null,
            persons: [],
            categories: [],
            paymentMethods: [],
            funds: [],
            transactions: [],
            currentTab: 'dashboard',
            filters: {
                person: '',
                category: '',
                limit: 50,
                offset: 0
            }
        };

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(amount);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('es-AR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showModal(type, data = null) {
            const modal = document.getElementById('modal');
            const authModal = document.getElementById('auth-modal');
            const installModal = document.getElementById('install-prompt');
            
            // Ocultar todos primero
            modal.classList.add('hidden');
            authModal.classList.add('hidden');
            installModal.classList.add('hidden');
            
            // Mostrar el modal correspondiente
            switch(type) {
                case 'transaction':
                    setupTransactionModal(data);
                    modal.classList.remove('hidden');
                    break;
                case 'auth':
                    authModal.classList.remove('hidden');
                    break;
                case 'install':
                    installModal.classList.remove('hidden');
                    break;
            }
        }

        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // ============================================
        // FUNCIONES SUPABASE
        // ============================================
        async function initializeApp() {
            showLoading();
            
            try {
                // Cargar datos est√°ticos
                await Promise.all([
                    loadPersons(),
                    loadCategories(),
                    loadPaymentMethods(),
                    loadFunds()
                ]);
                
                // Verificar autenticaci√≥n
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    state.session = session;
                    state.user = session.user;
                    updateAuthUI();
                    await loadDashboardData();
                } else {
                    showModal('auth');
                }
                
                // Cargar datos iniciales
                await loadRecentTransactions();
                updateBalances();
                updateBusinessData();
                updateFundsData();
                
            } catch (error) {
                console.error('Error inicializando app:', error);
                alert('Error al cargar la aplicaci√≥n. Recarga la p√°gina.');
            } finally {
                hideLoading();
            }
        }

        async function loadPersons() {
            const { data, error } = await supabaseClient
                .from('persons')
                .select('*')
                .order('display_order');
            
            if (!error) state.persons = data;
        }

        async function loadCategories() {
            const { data, error } = await supabaseClient
                .from('categories')
                .select('*')
                .order('display_order');
            
            if (!error) state.categories = data;
        }

        async function loadPaymentMethods() {
            const { data, error } = await supabaseClient
                .from('payment_methods')
                .select('*')
                .order('display_order');
            
            if (!error) state.paymentMethods = data;
        }

        async function loadFunds() {
            const { data, error } = await supabaseClient
                .from('funds')
                .select('*')
                .order('display_order');
            
            if (!error) state.funds = data;
        }

        async function loadDashboardData() {
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Cargar resumen mensual
            const { data: summary } = await supabaseClient
                .rpc('get_monthly_balance', { year_month: monthStart });
            
            if (summary && summary.length > 0) {
                const data = summary[0];
                document.getElementById('total-income').textContent = formatCurrency(data.total_income);
                document.getElementById('total-expense').textContent = formatCurrency(data.total_expense);
                document.getElementById('business-net').textContent = formatCurrency(data.business_net);
                document.getElementById('final-balance').textContent = formatCurrency(data.final_balance);
                
                // Actualizar indicador de estado
                const statusIndicator = document.getElementById('status-indicator');
                const statusProgress = document.getElementById('status-progress');
                
                if (data.final_balance > 0) {
                    statusIndicator.className = 'badge badge-success';
                    statusIndicator.textContent = 'OK';
                    statusProgress.className = 'progress-fill progress-success';
                    statusProgress.style.width = '100%';
                } else if (data.final_balance > -10000) {
                    statusIndicator.className = 'badge badge-warning';
                    statusIndicator.textContent = 'ALERTA';
                    statusProgress.className = 'progress-fill progress-warning';
                    statusProgress.style.width = '50%';
                } else {
                    statusIndicator.className = 'badge badge-danger';
                    statusIndicator.textContent = 'PELIGRO';
                    statusProgress.className = 'progress-fill progress-danger';
                    statusProgress.style.width = '25%';
                }
            }
        }

        async function loadRecentTransactions(limit = 10) {
            const { data, error } = await supabaseClient
                .from('transactions')
                .select(`
                    *,
                    category:categories(*),
                    person:persons(*),
                    payment_method:payment_methods(*),
                    fund:funds(*)
                `)
                .order('date', { ascending: false })
                .limit(limit);
            
            if (!error) {
                state.transactions = data;
                renderRecentTransactions();
            }
        }

        async function addTransaction(transactionData) {
            const { data, error } = await supabaseClient
                .from('transactions')
                .insert([{
                    ...transactionData,
                    created_by: state.user.id
                }])
                .select()
                .single();
            
            if (!error) {
                // Actualizar datos
                await Promise.all([
                    loadDashboardData(),
                    loadRecentTransactions(),
                    updateBalances(),
                    updateBusinessData(),
                    updateFundsData()
                ]);
                
                hideModal();
                alert('Movimiento agregado correctamente');
                return data;
            } else {
                throw error;
            }
        }

        // ============================================
        // FUNCIONES DE UI
        // ============================================
        function setupTransactionModal(data = null) {
            const form = document.getElementById('transaction-form');
            const dynamicFields = document.getElementById('dynamic-fields');
            const typeSelect = document.getElementById('transaction-type');
            const title = document.getElementById('modal-title');
            
            // Reset form
            form.reset();
            dynamicFields.innerHTML = '';
            
            // Set date to today
            document.getElementById('transaction-date').valueAsDate = new Date();
            
            if (data) {
                // Editar transacci√≥n existente
                title.textContent = 'Editar Movimiento';
                Object.keys(data).forEach(key => {
                    const input = document.getElementById(`transaction-${key}`);
                    if (input) input.value = data[key];
                });
            } else {
                title.textContent = 'Nuevo Movimiento';
            }
            
            // Event listener para cambios en tipo
            typeSelect.addEventListener('change', updateDynamicFields);
            
            // Configurar campos iniciales
            updateDynamicFields();
            
            function updateDynamicFields() {
                const type = typeSelect.value;
                let html = '';
                
                switch(type) {
                    case 'expense':
                        html = `
                            <div class="mb-3">
                                <label class="label">Categor√≠a</label>
                                <select id="transaction-category" class="input select" required>
                                    <option value="">Seleccionar categor√≠a</option>
                                    ${state.categories.filter(c => c.type === 'expense').map(c => 
                                        `<option value="${c.id}">${c.icon} ${c.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="label">Persona</label>
                                <select id="transaction-person" class="input select" required>
                                    <option value="">Seleccionar persona</option>
                                    ${state.persons.map(p => 
                                        `<option value="${p.id}">${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="label">Medio de Pago</label>
                                <select id="transaction-payment-method" class="input select" required>
                                    <option value="">Seleccionar medio</option>
                                    ${state.paymentMethods.map(p => 
                                        `<option value="${p.id}">${p.icon} ${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'income':
                        html = `
                            <div class="mb-3">
                                <label class="label">Tipo de Ingreso</label>
                                <select id="transaction-category" class="input select" required>
                                    <option value="">Seleccionar tipo</option>
                                    ${state.categories.filter(c => c.type === 'income').map(c => 
                                        `<option value="${c.id}">${c.icon} ${c.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="label">Persona</label>
                                <select id="transaction-person" class="input select" required>
                                    <option value="">Seleccionar persona</option>
                                    ${state.persons.map(p => 
                                        `<option value="${p.id}">${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="label">Medio de Pago</label>
                                <select id="transaction-payment-method" class="input select" required>
                                    <option value="">Seleccionar medio</option>
                                    ${state.paymentMethods.map(p => 
                                        `<option value="${p.id}">${p.icon} ${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'business_expense':
                        html = `
                            <div class="mb-3">
                                <label class="label">Persona</label>
                                <select id="transaction-person" class="input select" required>
                                    <option value="">Seleccionar persona</option>
                                    ${state.persons.map(p => 
                                        `<option value="${p.id}">${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="label">Medio de Pago</label>
                                <select id="transaction-payment-method" class="input select" required>
                                    <option value="">Seleccionar medio</option>
                                    ${state.paymentMethods.map(p => 
                                        `<option value="${p.id}">${p.icon} ${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'business_income':
                        html = `
                            <div class="mb-3">
                                <label class="label">Medio de Pago</label>
                                <select id="transaction-payment-method" class="input select" required>
                                    <option value="">Seleccionar medio</option>
                                    ${state.paymentMethods.map(p => 
                                        `<option value="${p.id}">${p.icon} ${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'fund_transfer':
                        html = `
                            <div class="mb-3">
                                <label class="label">Fondo Origen</label>
                                <select id="transaction-fund" class="input select" required>
                                    <option value="">Seleccionar fondo origen</option>
                                    ${state.funds.map(f => 
                                        `<option value="${f.id}">${f.icon} ${f.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="label">Fondo Destino</label>
                                <select id="transaction-to-fund" class="input select" required>
                                    <option value="">Seleccionar fondo destino</option>
                                    ${state.funds.map(f => 
                                        `<option value="${f.id}">${f.icon} ${f.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="label">Medio de Pago</label>
                                <select id="transaction-payment-method" class="input select" required>
                                    <option value="">Seleccionar medio</option>
                                    ${state.paymentMethods.map(p => 
                                        `<option value="${p.id}">${p.icon} ${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                        break;
                }
                
                dynamicFields.innerHTML = html;
            }
        }

        function renderRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            const transactions = state.transactions.slice(0, 10);
            
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">No hay movimientos recientes</p>';
                return;
            }
            
            container.innerHTML = transactions.map(t => `
                <div class="transaction-item">
                    <div class="transaction-icon" style="background: ${getCategoryColor(t.category.type)}20">
                        ${t.category?.icon || 'üí∞'}
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-title">${t.category?.name || 'Movimiento'}</div>
                        <div class="transaction-meta">
                            ${formatDate(t.date)} ‚Ä¢ ${t.person?.name || ''} ‚Ä¢ ${t.payment_method?.name || ''}
                            ${t.note ? `‚Ä¢ ${t.note}` : ''}
                        </div>
                    </div>
                    <div class="transaction-amount ${getAmountColor(t.type)}">
                        ${t.type.includes('expense') ? '-' : '+'}${formatCurrency(t.amount)}
                    </div>
                </div>
            `).join('');
        }

        async function updateBalances() {
            // En una app real, esto vendr√≠a de la funci√≥n get_current_balance
            // Por ahora simulamos con datos de las transacciones
            
            const cashId = state.paymentMethods.find(p => p.name === 'Efectivo')?.id;
            const mpId = state.paymentMethods.find(p => p.name === 'Mercado Pago')?.id;
            
            if (!cashId || !mpId) return;
            
            // Calcular saldos desde transacciones
            let cashBalance = 0;
            let mpBalance = 0;
            
            state.transactions.forEach(t => {
                const amount = t.type.includes('expense') ? -t.amount : t.amount;
                
                if (t.payment_method_id === cashId) {
                    cashBalance += amount;
                } else if (t.payment_method_id === mpId) {
                    mpBalance += amount;
                }
            });
            
            document.getElementById('cash-balance').textContent = formatCurrency(cashBalance);
            document.getElementById('mp-balance').textContent = formatCurrency(mpBalance);
            document.getElementById('total-balance').textContent = formatCurrency(cashBalance + mpBalance);
        }

        async function updateBusinessData() {
            // Calcular datos de negocio
            const businessTransactions = state.transactions.filter(t => 
                t.type.includes('business')
            );
            
            const sales = businessTransactions
                .filter(t => t.type === 'business_income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const supplies = businessTransactions
                .filter(t => t.type === 'business_expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const profit = sales - supplies;
            
            document.getElementById('total-sales').textContent = formatCurrency(sales);
            document.getElementById('total-supplies').textContent = formatCurrency(supplies);
            document.getElementById('business-profit').textContent = formatCurrency(profit);
            
            // Actualizar fondo postres
            const dessertFund = state.funds.find(f => f.name === 'Fondo fijo postres');
            if (dessertFund) {
                const progress = (dessertFund.current_amount / dessertFund.target_amount) * 100;
                document.getElementById('business-fund-progress').textContent = 
                    `${formatCurrency(dessertFund.current_amount)} / ${formatCurrency(dessertFund.target_amount)}`;
                document.getElementById('business-fund-bar').style.width = `${Math.min(progress, 100)}%`;
            }
        }

        async function updateFundsData() {
            state.funds.forEach(fund => {
                if (fund.name === 'Fondo fijo hogar') {
                    const progress = (fund.current_amount / fund.target_amount) * 100;
                    const remaining = fund.target_amount - fund.current_amount;
                    
                    document.getElementById('home-fund-progress').textContent = 
                        formatCurrency(fund.current_amount);
                    document.getElementById('home-fund-bar').style.width = `${Math.min(progress, 100)}%`;
                    document.getElementById('home-fund-remaining').textContent = 
                        `Faltan ${formatCurrency(remaining)} para el objetivo`;
                }
                
                if (fund.name === 'Fondo fijo postres') {
                    const progress = (fund.current_amount / fund.target_amount) * 100;
                    const remaining = fund.target_amount - fund.current_amount;
                    
                    document.getElementById('dessert-fund-progress').textContent = 
                        formatCurrency(fund.current_amount);
                    document.getElementById('dessert-fund-bar').style.width = `${Math.min(progress, 100)}%`;
                    document.getElementById('dessert-fund-remaining').textContent = 
                        `Faltan ${formatCurrency(remaining)} para el objetivo`;
                }
            });
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            if (state.user) {
                authBtn.innerHTML = 'üë§';
                authBtn.title = `Conectado como ${state.user.email}`;
            } else {
                authBtn.innerHTML = 'üîì';
                authBtn.title = 'Iniciar sesi√≥n';
            }
        }

        function getCategoryColor(type) {
            const colors = {
                'expense': '#ef4444',
                'income': '#10b981',
                'business_expense': '#f59e0b',
                'business_income': '#8b5cf6',
                'fund_transfer': '#3b82f6'
            };
            return colors[type] || '#64748b';
        }

        function getAmountColor(type) {
            return type.includes('expense') ? 'text-danger' : 'text-success';
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Navegaci√≥n por tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Actualizar tabs activos
                    document.querySelectorAll('.nav-tab').forEach(t => 
                        t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Mostrar contenido correspondiente
                    document.querySelectorAll('.tab-content').forEach(content => 
                        content.classList.add('hidden'));
                    document.getElementById(tab.dataset.tab).classList.remove('hidden');
                    
                    state.currentTab = tab.dataset.tab;
                    
                    // Cargar datos espec√≠ficos del tab
                    switch(state.currentTab) {
                        case 'history':
                            loadHistory();
                            break;
                        case 'expenses':
                            loadCategoryData();
                            break;
                    }
                });
            });
            
            // Botones de acci√≥n r√°pida
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    
                    switch(action) {
                        case 'add-expense':
                            showModal('transaction');
                            document.getElementById('transaction-type').value = 'expense';
                            document.getElementById('transaction-type').dispatchEvent(new Event('change'));
                            break;
                        case 'add-income':
                            showModal('transaction');
                            document.getElementById('transaction-type').value = 'income';
                            document.getElementById('transaction-type').dispatchEvent(new Event('change'));
                            break;
                        case 'add-sale':
                            showModal('transaction');
                            document.getElementById('transaction-type').value = 'business_income';
                            document.getElementById('transaction-type').dispatchEvent(new Event('change'));
                            break;
                        case 'transfer-funds':
                            showModal('transaction');
                            document.getElementById('transaction-type').value = 'fund_transfer';
                            document.getElementById('transaction-type').dispatchEvent(new Event('change'));
                            break;
                    }
                });
            });
            
            // Modal buttons
            document.getElementById('modal-cancel').addEventListener('click', hideModal);
            document.getElementById('modal-save').addEventListener('click', async (e) => {
                e.preventDefault();
                
                const form = document.getElementById('transaction-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const formData = {
                    type: document.getElementById('transaction-type').value,
                    date: document.getElementById('transaction-date').value,
                    amount: parseFloat(document.getElementById('transaction-amount').value),
                    note: document.getElementById('transaction-note').value
                };
                
                // Campos espec√≠ficos por tipo
                const type = formData.type;
                
                switch(type) {
                    case 'expense':
                    case 'income':
                        formData.category_id = document.getElementById('transaction-category').value;
                        formData.person_id = document.getElementById('transaction-person').value;
                        formData.payment_method_id = document.getElementById('transaction-payment-method').value;
                        break;
                    case 'business_expense':
                        formData.category_id = state.categories.find(c => c.name === 'Insumos postres').id;
                        formData.person_id = document.getElementById('transaction-person').value;
                        formData.payment_method_id = document.getElementById('transaction-payment-method').value;
                        break;
                    case 'business_income':
                        formData.category_id = state.categories.find(c => c.name === 'Ventas postres').id;
                        formData.payment_method_id = document.getElementById('transaction-payment-method').value;
                        break;
                    case 'fund_transfer':
                        formData.category_id = state.categories.find(c => c.name === 'Transferencia entre fondos').id;
                        formData.fund_id = document.getElementById('transaction-fund').value;
                        formData.to_fund_id = document.getElementById('transaction-to-fund').value;
                        formData.payment_method_id = document.getElementById('transaction-payment-method').value;
                        break;
                }
                
                try {
                    showLoading();
                    await addTransaction(formData);
                } catch (error) {
                    console.error('Error agregando transacci√≥n:', error);
                    alert('Error al guardar el movimiento');
                } finally {
                    hideLoading();
                }
            });
            
            // Auth buttons
            document.getElementById('authBtn').addEventListener('click', () => {
                if (state.user) {
                    // Mostrar menu de usuario
                    if (confirm('¬øCerrar sesi√≥n?')) {
                        supabaseClient.auth.signOut();
                        state.user = null;
                        state.session = null;
                        updateAuthUI();
                        showModal('auth');
                    }
                } else {
                    showModal('auth');
                }
            });
            
            document.getElementById('auth-login').addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                
                if (!email || !password) {
                    alert('Por favor completa email y contrase√±a');
                    return;
                }
                
                try {
                    showLoading();
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    state.user = data.user;
                    state.session = data.session;
                    updateAuthUI();
                    hideModal();
                    await initializeApp();
                } catch (error) {
                    alert('Error al iniciar sesi√≥n: ' + error.message);
                } finally {
                    hideLoading();
                }
            });
            
            document.getElementById('auth-signup').addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                
                if (!email || !password) {
                    alert('Por favor completa email y contrase√±a');
                    return;
                }
                
                if (password.length < 6) {
                    alert('La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }
                
                try {
                    showLoading();
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    alert('¬°Cuenta creada! Revisa tu email para confirmar.');
                    hideModal();
                } catch (error) {
                    alert('Error al crear cuenta: ' + error.message);
                } finally {
                    hideLoading();
                }
            });
            
            // Install button
            let deferredPrompt;
            const installBtn = document.getElementById('installBtn');
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'flex';
            });
            
            installBtn.addEventListener('click', () => {
                if (deferredPrompt) {
                    showModal('install');
                }
            });
            
            document.getElementById('install-confirm').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        installBtn.style.display = 'none';
                    }
                    deferredPrompt = null;
                }
                hideModal();
            });
            
            document.getElementById('install-cancel').addEventListener('click', hideModal);
            
            // Inicializar app
            if (supabaseClient) {
                initializeApp();
            } else {
                document.getElementById('loading').innerHTML = 
                    '<div class="text-center p-8"><p class="text-danger">Error: Supabase no est√° configurado</p></div>';
            }
        });
    </script>
</body>
</html>
